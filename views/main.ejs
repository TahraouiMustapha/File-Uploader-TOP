<html>
    <head>
        <link rel="stylesheet" href="/styles/global.css">
        <link rel="stylesheet" href="/styles/main.css">
        <title>File Uploader</title>
    </head>
    <body>
        <%-include('partials/header')%>

        <section class="main">
            <nav class="left-side">
                <div class="nav-btns">
                    <a href=<%=locals.isShared ? locals.sharedLink : '/' %> class="btn hoveredBtn">
                        <img src="/assets/icons/home.svg" alt="home">
                        Home
                    </a>

                    <div id="newFolderBtn" class="btn">
                        <img src="/assets/icons/documents.svg" alt="new-folder">
                        New Folder
                    </div>

                    <div id="newFileBtn" class="btn">
                        <img src="/assets/icons/upload.png" alt="new-file">
                        Upload File
                    </div>

                </div>
                
                <div class="about">
                    <div class="big-files-logo">
                        <img src="/assets/images/files-2.png" alt="big-files">
                    </div>

                    <div class="info">
                        <span>Created by </span><a href="https://github.com/TahraouiMustapha" target="_blank">Tahraoui mustapha</a> 
                        <span>Design inspired by</span> <a href="https://www.youtube.com/watch?v=lie0cr3wESQ&t=178s" target="_blank">Js Mastery</a>
                    </div>
                </div>

            </nav>

            <div class="main-content">
                <div class="navigation-state">
                    <%if(locals.path) {%>
                        <p>
                            <a href="/"><%=user.username%></a> 
                            <%path.forEach(pathObj => {%>
                                <%='>'%> <a href=<%=pathObj.folderHref%>> <%=pathObj.folderName%></a>
                            <%})%>
                        </p>
                    <%} else {%>
                            <p><a href="/"><%=user.username%></a></p>
                    <%}%> 
                </div>

                <%if(!locals.rootFolder){ %>
                    <div class="storage">
                        <div class="circular">
                            <div class="outer">
                                <div class="inner">
                                    <div class="number">
                                        <p>75%</p>
                                        Space used
                                    </div>
                                </div>
                            </div>

                            <!-- under circle to color the gap  -->
                            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="160px" height="160px">
                                    <circle cx="80" cy="80" r="70" stroke-linecap="round" class="gap-circle"/>
                            </svg>

                            <!-- circle for available storage -->
                            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="160px" height="160px">
                                    <circle cx="80" cy="80" r="70" stroke-linecap="round"  class="main-circle"/>
                            </svg>


                        </div>
                        
                        <div class="available-storage">
                            <h3>Available storage</h3>
                            <p>2GB/15GB</p>
                        </div>
                    </div>
                <%}%>
                <%if(userFiles) {%>
                       <div class="files-container">
                           <%-include('partials/folderContent')%>
                       </div>
                   <%} else {%>
                       <div class="message-no-files">
                           <%if(locals.rootFolder) { %>
                               <p>no files or folders to display</p>
                           <%} else { %>
                               <p>Create a new folder to get started</p>
                           <%}%>
                       </div>
                   <%}%>
            </div>

            <!-- new folder form -->
            <%-include('partials/newFolderForm')%>

            <!-- uplaod file form -->
            <%-include('partials/uploadFileForm')%>
             <%if(messages.dialog == 'upload'){ %>
                <script>
                    const newFileDialog = document.querySelector('#newFileDialog');
                    newFileDialog.showModal()
                </script>
            <%}%>
        </section>

        


    
            <!-- aside to appear file info -->
             <%if(locals.clickedFile) {%>
                <aside class="side" id="sideOfFileInfo">
                    <div class="head">
                        <h2>File Information</h2>
                        <button class="closeSide">X</button>
                    </div>
                    <div class="info">
                        <p>
                            <span>Name</span> : <%=clickedFile.name%>
                        </p>
                        <p>
                            <span>Type</span> : <%=clickedFile.mimetype%>
                        </p>
                        <p>
                            <span>Size</span> : <%=clickedFile.size%>
                        </p>
                        <p>
                            <span>Created</span> : <%=clickedFile.createdDate%> 
                        </p>
                    
                    </div>
                    <div class="btns">
                        <button class="closeSide">close</button>
                        <button id="shareFileBtn">share</button>
                        <a href="/files/delete/<%=clickedFile.fileid%>">delete</a>
                        <a href="/files/download/<%=clickedFile.fileid%>" id="downloadBtn">download</a>
                    </div>
                </aside>

                <script>
                    const side = document.querySelector('#sideOfFileInfo') 
                    side.style.transform = 'scaleX(1)'
                </script>
            <%}%>
        
            
            <%if(locals.rootFolder) {%>
                <!-- delete folder dilaog -->
                <%-include('partials/deleteFolder', { folderid: rootFolder.folderid })%>
                <!-- dialog for generating a shared folder link -->
                <%-include('partials/shareFolder', { folderid: rootFolder.folderid })%>
                <%if(messages.generatedLink) {%>
                    <script>
                        const shareFolderDialog = document.querySelector('#shareFolderDialog') 
                        shareFolderDialog.showModal()
                    </script>
                <%}%>    
    
            <%}%>

            <!-- dialog for generating a shared file link -->
            <%if(locals.clickedFile){ %>
                <%-include('partials/shareFile', {fileid: clickedFile.fileid})%>
                <%if(messages.generatedFileLink) {%>
                    <script>
                        const shareFileDialog = document.querySelector('#shareFileDialog')
                        shareFileDialog.showModal()
                    </script>
                <%}%>                    
            <%}%>    
        </section>

    </body>
    <script>
        const newFileBtn = document.getElementById('newFileBtn');
        const exitNewFileBtn = document.getElementById('exitNewFileBtn');


        const newFolderBtn = document.querySelector('#newFolderBtn');
        const newFolderDialog = document.querySelector('#newFolderDialog');
        const exitNewFolderBtn = document.querySelector('#exitNewFolderBtn')
        const folderNameInput = document.querySelector('input[name = \"folderName\"]')

        const deleteFolderBtn = document.querySelector('#deleteFolderBtn');
        const deleteDialog = document.querySelector('#deleteDialog');
        const cancelDelete = document.querySelector('#cancelDelete');
        const exitDeleteDialog = document.querySelector("#exitDeleteDialog")

        // for side that diplays file info
        const closeSideBtn = Array.from(document.querySelectorAll('.closeSide'))

        // for share folder dilaog
        const shareFolderBtn = document.querySelector('#shareFolderBtn')
        if(typeof shareFolderDialog === "undefined") {
            const shareFolderDialog = document.querySelector('#shareFolderDialog') 
        }
        const exitShareDialogBtn = document.querySelector('#exitShareDialogBtn')
        const cancelSharing = document.querySelector('#cancelSharing')

        // for share file dialog
        const shareFileBtn = document.querySelector('#shareFileBtn')
        if(typeof shareFileDialog === "undefined" ) {
            const shareFileDialog = document.querySelector('#shareFileDialog')
        }
        const cancelShareFile = Array.from(document.querySelectorAll('.cancelShareFile'))
        
 
        if(newFileBtn){
            newFileBtn.addEventListener('click', ()=> {
                newFileDialog.showModal()
            })
        }

        if(newFolderBtn){
            newFolderBtn.addEventListener('click', ()=> {
                newFolderDialog.showModal()
            })
        }

        exitNewFileBtn.addEventListener('click', ()=> {
            newFileDialog.close()
        })

        exitNewFolderBtn.addEventListener('click', ()=> {
            folderNameInput.value = ''
            newFolderDialog.close()
        })

        // about ensuring the delete process
        if(deleteFolderBtn) {
            deleteFolderBtn.addEventListener('click', ()=> {
                deleteDialog.showModal()
            })
        }

        if(cancelDelete) {
            cancelDelete.addEventListener('click', ()=> {
                deleteDialog.close()
            })
        }

        if(exitDeleteDialog) {
            exitDeleteDialog.addEventListener('click', ()=> {
                deleteDialog.close()
            })
        }

        // close the side 
        if(closeSideBtn.length > 0) {
            closeSideBtn.forEach(btn => {
                btn.addEventListener('click', ()=> {
                    side.style.transform = 'scaleX(0)'
                })
            })
        }


        if(shareFolderBtn) {
            shareFolderBtn.addEventListener('click', ()=> {
                if(shareFolderDialog) {
                    shareFolderDialog.showModal()
                }
            })
        }

        if(exitShareDialogBtn && cancelSharing) {
            [exitShareDialogBtn, cancelSharing ].forEach(btn => {
                btn.addEventListener('click', ()=> {
                    shareFolderDialog.close()
                })
            })
        }

        if(shareFileBtn) {
            shareFileBtn.addEventListener('click', ()=> {
                shareFileDialog.showModal()
            })
        }

        if(cancelShareFile.length > 0) {
            cancelShareFile.forEach(btn => {
                btn.addEventListener('click', ()=> {
                    shareFileDialog.close()
                })
            })
        }
    </script>
</html>